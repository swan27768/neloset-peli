<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Neloset</title>

    <style>
      :root {
        --bg: #0f172a;
        --card: #1e293b;
        --text: #f1f5f9;
        --muted: #94a3b8;
        --accent: #3b82f6;
        --good: #22c55e;
        --bad: #ef4444;
      }

      body {
        margin: 0;
        font-family: system-ui;
        background: linear-gradient(180deg, #0f172a, #020617);
        color: var(--text);
      }

      .wrap {
        max-width: 1100px;
        margin: auto;
        padding: 20px;
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        color: var(--muted);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      .tile {
        background: var(--card);
        padding: 18px;
        text-align: center;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }

      .tile.selected {
        background: var(--accent);
      }
      .tile.revealed {
        background: var(--good);
      }
      .tile.locked {
        background: #334155;
        opacity: 0.7;
      }

      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      button {
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
      }

      .primary {
        background: var(--accent);
        color: white;
      }
      .good {
        background: var(--good);
        color: white;
      }
      .bad {
        background: var(--bad);
        color: white;
      }

      .panel {
        margin-top: 30px;
        background: var(--card);
        padding: 15px;
        border-radius: 12px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      td,
      th {
        border-bottom: 1px solid #334155;
        padding: 6px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Neloset</h1>

      <div class="stats">
        <div>Yritykset: <span id="tries">0</span></div>
        <div>Vihjeet: <span id="hints">3</span></div>
      </div>

      <div class="grid" id="grid"></div>

      <div class="controls">
        <button class="primary" onclick="checkSelection()">Tarkista</button>
        <button onclick="giveHint()">Vihje</button>
        <button class="bad" onclick="resetGame()">Uusi peli</button>
      </div>

      <div class="panel">
        <h2>Tallenna tulos</h2>
        <input id="playerName" placeholder="Oppilaan nimi" />
        <button class="good" onclick="saveResult()">Tallenna tulos</button>
      </div>

      <div class="panel">
        <h2>Leaderboard (TOP 10)</h2>
        <div id="resultsArea"></div>
      </div>
    </div>

    <script>
      const WEBAPP_URL =
        "https://script.google.com/macros/s/AKfycbxl8JEwDVVx-feF4_wEK9W5ZhbbNMzVv5bwXu7cDFZzPbhpiwMVKp8h686fele5c2ZYQw/exec";

      const PUZZLE = {
        groups: [
          { name: "ELÄIMET", words: ["kissa", "koira", "lehmä", "hevonen"] },
          {
            name: "VÄRIT",
            words: ["punainen", "sininen", "vihreä", "keltainen"],
          },
          { name: "SÄÄ", words: ["sade", "lumi", "tuuli", "pouta"] },
          { name: "KOULU", words: ["kynä", "vihko", "reppu", "kumi"] },
        ],
      };

      let tiles = [];
      let selected = new Set();
      let solved = new Set();
      let tries = 0;
      let hints = 3;

      function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function buildTiles() {
        let arr = [];
        PUZZLE.groups.forEach((g, i) => {
          g.words.forEach((w) => {
            arr.push({ word: w, group: i, state: "normal" });
          });
        });
        return shuffle(arr);
      }

      function render() {
        document.getElementById("tries").textContent = tries;
        document.getElementById("hints").textContent = hints;

        const grid = document.getElementById("grid");
        grid.innerHTML = "";
        tiles.forEach((t, i) => {
          const d = document.createElement("div");
          d.className = "tile";
          if (selected.has(i)) d.classList.add("selected");
          if (t.state === "revealed") d.classList.add("revealed");
          d.textContent = t.word;
          d.onclick = () => {
            if (t.state !== "normal") return;
            if (selected.has(i)) selected.delete(i);
            else if (selected.size < 4) selected.add(i);
            render();
          };
          grid.appendChild(d);
        });
      }

      function checkSelection() {
        if (selected.size !== 4) return;
        tries++;
        const idx = [...selected];
        const g = tiles[idx[0]].group;
        if (idx.every((i) => tiles[i].group === g)) {
          idx.forEach((i) => (tiles[i].state = "revealed"));
        }
        selected.clear();
        render();
      }

      function giveHint() {
        if (hints <= 0) return;
        hints--;
        tries++;
        render();
      }

      function saveResult() {
        const name = document.getElementById("playerName").value.trim();
        if (!name) {
          alert("Syötä nimi");
          return;
        }

        const url =
          WEBAPP_URL +
          "?name=" +
          encodeURIComponent(name) +
          "&tries=" +
          tries +
          "&gameId=default" +
          "&timeSeconds=0" +
          "&score=" +
          tries;

        fetch(url)
          .then(() => loadLeaderboard())
          .catch((err) => {
            console.error(err);
            alert("Virhe lähetyksessä.");
          });
      }

      function loadLeaderboard() {
        fetch(WEBAPP_URL)
          .then((res) => res.json())
          .then((data) => {
            let html =
              "<table><tr><th>Sija</th><th>Nimi</th><th>Yritykset</th></tr>";
            data.forEach((r, i) => {
              html += `<tr><td>${i + 1}</td><td>${r.name}</td><td>${r.tries}</td></tr>`;
            });
            html += "</table>";
            document.getElementById("resultsArea").innerHTML = html;
          });
      }

      function resetGame() {
        tiles = buildTiles();
        selected.clear();
        solved.clear();
        tries = 0;
        hints = 3;
        render();
      }

      resetGame();
      loadLeaderboard();
    </script>
  </body>
</html>
