<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Neloset</title>

    <style>
      :root {
        --bg: #0f172a;
        --card: #1e293b;
        --text: #f1f5f9;
        --muted: #94a3b8;
        --accent: #3b82f6;
        --good: #22c55e;
        --bad: #ef4444;
      }

      body {
        margin: 0;
        font-family: system-ui;
        background: linear-gradient(180deg, #0f172a, #020617);
        color: var(--text);
      }

      .wrap {
        max-width: 1100px;
        margin: auto;
        padding: 20px;
      }

      h1 {
        margin: 0 0 10px 0;
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        color: var(--muted);
      }

      .solved-area {
        display: grid;
        gap: 10px;
        margin-bottom: 15px;
      }

      .category-box {
        padding: 15px;
        border-radius: 12px;
        font-weight: bold;
        animation: pop 0.3s ease;
      }

      @keyframes pop {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      .tile {
        background: var(--card);
        padding: 18px;
        text-align: center;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.15s;
        font-weight: 600;
      }

      .tile:hover {
        transform: translateY(-2px);
      }

      .tile.selected {
        background: var(--accent);
      }

      .tile.revealed {
        background: var(--good);
      }

      .tile.locked {
        background: #334155;
        opacity: 0.7;
      }

      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      button {
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
      }

      .primary {
        background: var(--accent);
        color: white;
      }
      .good {
        background: var(--good);
        color: white;
      }
      .bad {
        background: var(--bad);
        color: white;
      }

      .status {
        margin-top: 10px;
        color: var(--muted);
        min-height: 20px;
      }

      .panel {
        margin-top: 30px;
        background: var(--card);
        padding: 15px;
        border-radius: 12px;
      }

      input {
        padding: 6px;
        margin: 4px 0;
        width: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      td,
      th {
        border-bottom: 1px solid #334155;
        padding: 6px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Neloset</h1>

      <div class="stats">
        <div>Yritykset: <span id="tries">0</span></div>
        <div>Vihjeet: <span id="hints">3</span></div>
      </div>

      <div class="solved-area" id="solvedArea"></div>

      <div class="grid" id="grid"></div>

      <div class="controls">
        <button class="primary" onclick="checkSelection()">Tarkista</button>
        <button onclick="giveHint()">Vihje</button>
        <button class="bad" onclick="resetGame()">Uusi peli</button>
      </div>

      <div class="status" id="status"></div>

      <!-- OPPILAAN TULOS -->
      <div class="panel">
        <h2>Tallenna tulos</h2>
        <input id="playerName" placeholder="Oppilaan nimi" />
        <button class="good" onclick="saveResult()">Tallenna tulos</button>
      </div>

      <!-- OPETTAJAN NÄKYMÄ -->
      <div class="panel">
        <h2>Opettajan tulosnäkymä</h2>
        <button onclick="showResults()">Näytä tulokset</button>
        <button onclick="clearResults()">Tyhjennä tulokset</button>
        <div id="resultsArea"></div>
      </div>
    </div>

    <script>
      const PUZZLE = {
        groups: [
          {
            name: "ELÄIMET",
            color: "#f97316",
            words: ["kissa", "koira", "lehmä", "hevonen"],
          },
          {
            name: "VÄRIT",
            color: "#3b82f6",
            words: ["punainen", "sininen", "vihreä", "keltainen"],
          },
          {
            name: "SÄÄ",
            color: "#a855f7",
            words: ["sade", "lumi", "tuuli", "pouta"],
          },
          {
            name: "KOULU",
            color: "#22c55e",
            words: ["kynä", "vihko", "reppu", "kumi"],
          },
        ],
      };

      let tiles = [];
      let selected = new Set();
      let solved = new Set();
      let tries = 0;
      let hints = 3;

      function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function buildTiles() {
        let arr = [];
        PUZZLE.groups.forEach((g, i) => {
          g.words.forEach((w) => {
            arr.push({ word: w, group: i, state: "normal" });
          });
        });
        return shuffle(arr);
      }

      function render() {
        document.getElementById("tries").textContent = tries;
        document.getElementById("hints").textContent = hints;

        const grid = document.getElementById("grid");
        grid.innerHTML = "";
        tiles.forEach((t, i) => {
          const d = document.createElement("div");
          d.className = "tile";
          if (selected.has(i)) d.classList.add("selected");
          if (t.state === "revealed") d.classList.add("revealed");
          if (t.state === "locked") d.classList.add("locked");
          d.textContent = t.word;
          d.onclick = () => {
            if (t.state !== "normal") return;
            if (selected.has(i)) selected.delete(i);
            else if (selected.size < 4) selected.add(i);
            render();
          };
          grid.appendChild(d);
        });

        const solvedArea = document.getElementById("solvedArea");
        solvedArea.innerHTML = "";
        solved.forEach((i) => {
          const box = document.createElement("div");
          box.className = "category-box";
          box.style.background = PUZZLE.groups[i].color;
          box.textContent =
            PUZZLE.groups[i].name + " – " + PUZZLE.groups[i].words.join(", ");
          solvedArea.appendChild(box);
        });
      }

      function checkSelection() {
        if (selected.size !== 4) return;
        tries++;
        const idx = [...selected];
        const g = tiles[idx[0]].group;
        if (idx.every((i) => tiles[i].group === g)) {
          solved.add(g);
          idx.forEach((i) => (tiles[i].state = "revealed"));
          document.getElementById("status").textContent = "Oikein!";
        } else {
          document.getElementById("status").textContent = "Väärä ryhmä.";
        }
        selected.clear();
        render();
      }

      function giveHint() {
        if (hints <= 0) return;
        hints--;
        tries++;
        const remaining = PUZZLE.groups
          .map((_, i) => i)
          .filter((i) => !solved.has(i));
        if (!remaining.length) return;
        const gi = remaining[Math.floor(Math.random() * remaining.length)];
        tiles
          .filter((t) => t.group === gi && t.state === "normal")
          .slice(0, 2)
          .forEach((t) => (t.state = "locked"));
        render();
      }

      function saveResult() {
        const name = document.getElementById("playerName").value.trim();
        if (!name) {
          alert("Syötä nimi");
          return;
        }

        const payload = {
          name: name,
          tries: tries,
          gameId: "default",
          timeSeconds:
            typeof timeLimit !== "undefined" ? timeLimit - timeLeft : 0,
          score:
            typeof timeLimit !== "undefined"
              ? tries + (timeLimit - timeLeft) / 10
              : tries,
        };

        fetch(
          "https://script.google.com/macros/s/AKfycby798nyGje2iwyMyahFi-wB0GrnUkymJGYH9uhs9g4Hl2O7h056xy1sx6J8pcQWjocjjQ/exec",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          },
        )
          .then((res) => res.json())
          .then((data) => {
            alert("Tulos lähetetty onnistuneesti!");
          })
          .catch((err) => {
            console.error(err);
            alert("Virhe lähetyksessä.");
          });
      }

      function showResults() {
        const results = JSON.parse(
          localStorage.getItem("nelosetResults") || "[]",
        );
        let html =
          "<table><tr><th>Nimi</th><th>Yritykset</th><th>Aika</th></tr>";
        results.forEach((r) => {
          html += `<tr><td>${r.name}</td><td>${r.tries}</td><td>${r.date}</td></tr>`;
        });
        html += "</table>";
        document.getElementById("resultsArea").innerHTML = html;
      }

      function clearResults() {
        localStorage.removeItem("nelosetResults");
        document.getElementById("resultsArea").innerHTML = "";
      }

      function resetGame() {
        tiles = buildTiles();
        selected.clear();
        solved.clear();
        tries = 0;
        hints = 3;
        document.getElementById("status").textContent = "";
        render();
      }

      resetGame();
    </script>
  </body>
</html>
